# **问题**

线上有一个场景：有一个会议室的controller设备报警了，之后又自动恢复了，但运维平台上没有恢复成功，仍然在不停的发送报警消息

# **定位**

代码逻辑：

![img](https://zalav54l6d.feishu.cn/space/api/box/stream/download/asynccode/?code=ODFmZWM4NmJlZjBlZWMwZjc3YTcwNWUwZGYwMzU2MDlfb1luOGw2cXp0T3hDd09UbXdlcHQzQ29VaVBTeVdwcFJfVG9rZW46RUc3MGJqZ1BYb0hHRVF4UzNaOGN3c013bmZ4XzE3MDMwODMzOTE6MTcwMzA4Njk5MV9WNA)

# 场景信息

这是两个请求的请求时间和请求信息，可以看出，这台设备的报警请求和恢复请求，之间仅相差242ms，

报警请求：

![img](https://zalav54l6d.feishu.cn/space/api/box/stream/download/asynccode/?code=NzYyYTJiYTRkMjcxNGRkNTBjODhkMGQ2MzY1NmMyNzBfeWlLaUkwaTI4TmhrNWkyOUI1SnhWVEdFc2lNYnNlSkdfVG9rZW46QlFlVWJVRHVXb3pYTzF4czFZemMyTGJUblVFXzE3MDMwODMzOTE6MTcwMzA4Njk5MV9WNA)

恢复请求：

![img](https://zalav54l6d.feishu.cn/space/api/box/stream/download/asynccode/?code=OWI3Yzk0OTBiNWYwNWEwYzZiYmExMzlhYzZjNTE1ZWRfZHI4ZHVud29xWjgyc09OR1FaNEM0azFIMUQ5T2Q1cmFfVG9rZW46UGNtTWJuU0JWb1JVSGJ4a01CVWNZV1VUbm1jXzE3MDMwODMzOTE6MTcwMzA4Njk5MV9WNA)

如果在报警业务的保存操作之前，恢复业务完成了查询操作，那么就会恢复失败

# **协商**

和会议室方进行沟通，发现会议室的逻辑是在设备触发报警5分钟后，才会调用运维平台的报警接口，也就是说，在这个设备离线5分钟整的时候，恰好恢复了网络

所以会议室方不管把报警延迟多少分钟，都可能有这个巧合的发生

# **方案**

![img](https://zalav54l6d.feishu.cn/space/api/box/stream/download/asynccode/?code=YjVmOTNkYmIyMzllYWJhMTA5ZjE2MWJkNmRiZTE3ZTVfMGxlS25EeVhJQmhzcHlINzUxOGVqNFNIVzhOaHQ1OUVfVG9rZW46Tjl6TWJMMVY1b0ZybEl4YzRBU2N0M01IbldoXzE3MDMwODMzOTE6MTcwMzA4Njk5MV9WNA)

保证在并发时，报警业务的保存数据库操作在先，恢复业务的查询在后

目前该方案不是最优解，当报警请求和恢复请求并发，且线程阻塞时，存在恢复请求先被调度到的情况，最优方案仍在制作中。。。。。

# 更新一下方案

![img](https://zalav54l6d.feishu.cn/space/api/box/stream/download/asynccode/?code=Mjg4NjdiNWMyMDE0ZjI2YmRlZTdkODU4NDMyYzBlOTBfbXAwMXJvSFVZcHE4N0plZ014Qks2OVYzTUQwU0xsMGJfVG9rZW46R2pGWWI1NHNVbzFXSTl4NkpjWWNnOHl2bnZmXzE3MDMwODMzOTE6MTcwMzA4Njk5MV9WNA)

# 继续更新

![img](https://zalav54l6d.feishu.cn/space/api/box/stream/download/asynccode/?code=NjkyMzJkNjQ3ZDEwMDM2OTY0NzE2N2JmMTMxYWU2NTJfZ0x5dnZ5R3Vjd0dxTjl1RmhrRVV4WTNQSHR2ZXRoaXVfVG9rZW46SjRScWI2b3Zqb1VRMW94Rlh6dmNoYllnbjFuXzE3MDMwODMzOTE6MTcwMzA4Njk5MV9WNA)

# 线上验证

2022-12-13日晚9点进行上线，在次日上午9：38分时出现相同的case

如下图，同一设备的报警和恢复，报警先来，恢复后来，相差200ms

![img](https://zalav54l6d.feishu.cn/space/api/box/stream/download/asynccode/?code=NWRhZDA5M2RmOGQzYmUwMDMxYjY1MDE1ZTJkOTAzMzNfeFJ4RzdaN1N1MENzTlJDbnRSeVRwRmN4ZmV2eThJRndfVG9rZW46VzR2U2JtTDN2b2ZkMEJ4WkRPMmNpTmVSblZoXzE3MDMwODMzOTE6MTcwMzA4Njk5MV9WNA)

卡片正常发送，未出现最上面的恢复失败的问题

![img](https://zalav54l6d.feishu.cn/space/api/box/stream/download/asynccode/?code=NmM4MzRlNTQzMDUxMzI4MDRjODQyODM1MWMwNDgyNGJfUWdlNFFCeGVJY01UYnNlbGJGVUgxOWdHWkRTQ1ZDSHBfVG9rZW46U2xqOWJsR2dDb0dBMXN4YW5SV2NjUDFCblllXzE3MDMwODMzOTE6MTcwMzA4Njk5MV9WNA)

查看重试表中的重试记录，发现有本次恢复请求的重试记录

![img](https://zalav54l6d.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDMyMWJmZTViMjcwMWIwNmMyMmRiOWRkNzk2MmJkNTNfQk5NYWFVU3JFRmVqWHFMSXdNZGhGODY1YmVvTnFJeGJfVG9rZW46UFYwTWJCbWdmb0dic3J4blpLdWNLOHE0bkJkXzE3MDMwODMzOTE6MTcwMzA4Njk5MV9WNA)