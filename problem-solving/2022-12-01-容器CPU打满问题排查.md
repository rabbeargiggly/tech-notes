**现象**

线上服务打不开，网络超时

![img](https://zalav54l6d.feishu.cn/space/api/box/stream/download/asynccode/?code=NTQ0NDA3NTJiMWE4YWExOTQ1OGFiNjIzYzExNmY3MGZfWWl6V1VFdHBUTmNNd1dwczROTDhOZ2lPUXBETmlETndfVG9rZW46SnFRSGJBcG44b25TQmt4RlR1R2NNR2QwbnFlXzE3MDMwODM5MDc6MTcwMzA4NzUwN19WNA)

服务重启

![img](https://zalav54l6d.feishu.cn/space/api/box/stream/download/asynccode/?code=ODFlMTliYzgxODliMGFjNWI0NWE0MzZkYzdlZDBjNWFfbXFFRTdWUFNPUUU1Qm52WGpIejhuZERwbVZ5SFVFb0VfVG9rZW46QWNHcmJlbkpOb2ViSVd4aHZlWmMzdXlobjFlXzE3MDMwODM5MDc6MTcwMzA4NzUwN19WNA)

容器CPU打满

![img](https://zalav54l6d.feishu.cn/space/api/box/stream/download/asynccode/?code=MDE0NmNkY2Q0ZTAyY2RmNzI2N2RlYWM4ODJiZTlhNDhfb1ZrZHd0N0c2WTl5Z3JvZnJ4TTBHem1FTW9KY0NidHdfVG9rZW46UDduWGJsd25Ob05pV094aTgxOGNlVDhrbnljXzE3MDMwODM5MDc6MTcwMzA4NzUwN19WNA)

**排查**

日志量激增

![img](https://zalav54l6d.feishu.cn/space/api/box/stream/download/asynccode/?code=NjFiZGI1MjEwMzA2ZDFkMTEwNjAwNWY5M2NmZjI3YzJfMzk4am5yQzc3bzZocmY4aGhSODZhWFpXNXNKcUhqUHhfVG9rZW46V3RGMmJDbHhyb212aWR4WERzRWNhNjI2bjVjXzE3MDMwODM5MDc6MTcwMzA4NzUwN19WNA)

发现日志中有大量该内容

![img](https://zalav54l6d.feishu.cn/space/api/box/stream/download/asynccode/?code=MjM4ZDJiZTc5OWY1YWMwMGU0OTJlNjg0ZDgzZDZhMjhfV3dhR3hNNWE3SU03Z29wYjVxYlBpV2s5NVJUWUZlS2ZfVG9rZW46V0hWMWIwWDl5b2pQSmh4Q25WUWN1SHRMblVjXzE3MDMwODM5MDc6MTcwMzA4NzUwN19WNA)

其中查到的时间有2020年6月份的，怀疑是在批量处理报警记录

于是去Kibana中查询接口调用记录



查询之后才发现原因

# **结果**

全量导出（2020年6月开始）调用了7次 ，由于全量的报警数量较多，导致CPU打满

![img](https://zalav54l6d.feishu.cn/space/api/box/stream/download/asynccode/?code=MzI1YTdmMjZkODVkYzc5OGQ4ZGNiZjMxNmQ3ZDI3MzlfNFgwZ090SndaV2ZjdWxWT0JSV2dDSFFkVkpySERITk5fVG9rZW46TnZyU2JYZXdUb1hGR1d4Q2V2ZWNRRXNubmxiXzE3MDMwODM5MDc6MTcwMzA4NzUwN19WNA)

另外有十几次非全量导出

![img](https://zalav54l6d.feishu.cn/space/api/box/stream/download/asynccode/?code=YjQ4ZGJhNDgwZDdlZDliZTI1OGRlMDEyMTRhZTNmZjBfNW9YTWk1R3pmZng0UXNtSk9YNUhzNkM4azVQRUtmV29fVG9rZW46Qjhmd2JnREVlbzVvelN4TUtSc2NodGZSbkhnXzE3MDMwODM5MDc6MTcwMzA4NzUwN19WNA)

**影响**

接口稳定性降至 9.09%

![img](https://zalav54l6d.feishu.cn/space/api/box/stream/download/asynccode/?code=NjBlNzQ1NjIyMmE0OTc5ZjQ4M2VhMWZhNzcyYTc5YjZfZ3Y0ejRtYmtCb2NUUjBHVkFCVFpBb3BXZW1rZHNxRWRfVG9rZW46WXJFb2JKM05Rb3MwZjJ4OTBJVmNKWjRabmliXzE3MDMwODM5MDc6MTcwMzA4NzUwN19WNA)

服务SLA降至95.98%

![img](https://zalav54l6d.feishu.cn/space/api/box/stream/download/asynccode/?code=OTExNWI2ZjY0NDViMWJkMGMxOWYxZGY2NGI5MzhjZmNfM1BWQW0xWDhvaVRRNHJvVldNQ09MWk5Ed2R3YXBNeHRfVG9rZW46WVhjcWJoTlNJbzNZMHp4OFFGbGM2NlNHbnplXzE3MDMwODM5MDc6MTcwMzA4NzUwN19WNA)

# **改进方案**

报警记录导出接口加分布式锁，防止用户点击导出按钮之后，在导出过程中用户狂点